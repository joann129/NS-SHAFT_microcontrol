//
// TMR_LED : change LED on/off by Timer1 interrupt
//
#include <stdio.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include <math.h>
#include <string.h>
#include "LCD.h"

unsigned char people[16] = {
0x00, 0x00, 0x00, 0x16, 0x16, 0x9e, 0x8f, 0x9f, 0x7f, 0x5e, 0x9e, 0x96, 0x90, 0x10, 0x00, 0x00
};

unsigned char plat[32] = {
0x00, 0x10, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 
0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x10, 0x00
};

unsigned char sting[32] = {
0x00, 0x78, 0xfc, 0xfe, 0xfc, 0xf0, 0xf0, 0xf8, 0xfe, 0xf8, 0xf0, 0xf0, 0xf8, 0xfe, 0xfc, 0xf8, 
0xf0, 0xf8, 0xfe, 0xfe, 0xf8, 0xf8, 0xfc, 0xfe, 0xfc, 0xf8, 0xf8, 0xfc, 0xfe, 0xfe, 0xf8, 0x70
};

unsigned char bigsting[128] = {
0x1c, 0x1e, 0x3e, 0x3e, 0x7e, 0x7e, 0x7e, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 
0x7e, 0x7e, 0x7e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 0x7e, 0xfe, 0xfe, 0xfe, 
0xfe, 0xfe, 0xfe, 0xfe, 0x7e, 0x7e, 0x7e, 0x3e, 0x3e, 0x3e, 0x1e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 
0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0x7e, 0x7e, 0x3e, 0x3e, 0x3e, 0x3e, 0x1e, 0x1e, 
0x1e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0x7e, 0x7e, 0x7e, 0x3e, 0x3e, 
0x3e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 0xfe, 0xfe, 0xfe, 0xfe, 
0xfe, 0x7e, 0x7e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 
0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0x7e, 0x7e, 0x3e, 0x3e, 0x3e, 0x1c, 0x00, 0x00, 0x00
};

unsigned char platSting[4][32] = {
{0x00, 0x10, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 
0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x10, 0x00},
{0x00, 0x78, 0xfc, 0xfe, 0xfc, 0xf0, 0xf0, 0xf8, 0xfe, 0xf8, 0xf0, 0xf0, 0xf8, 0xfe, 0xfc, 0xf8, 
0xf0, 0xf8, 0xfe, 0xfe, 0xf8, 0xf8, 0xfc, 0xfe, 0xfc, 0xf8, 0xf8, 0xfc, 0xfe, 0xfe, 0xf8, 0x70},
{0x00, 0x78, 0xfc, 0xfe, 0xfc, 0xf0, 0xf0, 0xf8, 0xfe, 0xf8, 0xf0, 0xf0, 0xf8, 0xfe, 0xfc, 0xf8, 
0xf0, 0xf8, 0xfe, 0xfe, 0xf8, 0xf8, 0xfc, 0xfe, 0xfc, 0xf8, 0xf8, 0xfc, 0xfe, 0xfe, 0xf8, 0x70},
{0x00, 0x10, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 
0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x3c, 0x10, 0x00}
};

int16_t peoplex = 64;
int16_t peopley = 32;
int16_t platx[3] = {0,47,0};
int16_t platy[3] = {24,40,56};
int platType[3] = {0,0,0};
int seed;

uint8_t ledState = 0;
uint32_t keyin = 0;

volatile uint8_t u8ADF;

void ADC_IRQHandler(void)
{
    uint32_t u32Flag;

    u32Flag = ADC_GET_INT_FLAG(ADC, ADC_ADF_INT);
	
    if(u32Flag & ADC_ADF_INT)
        u8ADF = 1;

    ADC_CLR_INT_FLAG(ADC, u32Flag);
}

void Init_ADC(void)
{
    ADC_Open(ADC, ADC_INPUT_MODE, ADC_OPERATION_MODE, ADC_CH_6_MASK);
   ADC_POWER_ON(ADC);
    ADC_EnableInt(ADC, ADC_ADF_INT);
    NVIC_EnableIRQ(ADC_IRQn);
}

void TMR1_IRQHandler(void)
{	
	int i, j;
	ledState = ~ ledState;  // changing ON/OFF state
	//print_Line(2,"gan");
  /*if(ledState)
	{
		PC12 = 0;	
		PC13 = 1;	
	} 
  else	
	{
		PC12 = 1;	
		PC13 = 0;	
	}*/
	//clear_LCD();
	/*Clear(peoplex,peopley, 16);
	peopley -= 1;
	//for(j=0; j<100; j++)
	draw_Bmp16x8(peoplex,peopley,FG_COLOR,BG_COLOR,people);*/
	for(i=0; i<3; i++) {
		Clear(platx[i],platy[i], 32);
		platy[i] -= 1;
		//for(j=0; j<100; j++)
		draw_Bmp32x8(platx[i],platy[i],FG_COLOR,BG_COLOR,platSting[platType[i]]);
	}
	
	if(platy[0]==8) {
			Clear(platx[0],platy[0]-8, 32);
			platx[0] = platx[1];
			platx[1] = platx[2];
			platx[2] = rand() % 97;
			platy[0] = 24;
			platy[1] = 40;
			platy[2] = 56;
			platType[0] = platType[1];
			platType[1] = platType[2];
			platType[2] = rand() % 4;
	}
	
		
	
	TIMER_ClearIntFlag(TIMER1); // Clear Timer1 time-out interrupt flag
}

void Init_Timer1(void)
{
  TIMER_Open(TIMER1, TIMER_PERIODIC_MODE, 8.16);
  TIMER_EnableInt(TIMER1);
  NVIC_EnableIRQ(TMR1_IRQn);
  TIMER_Start(TIMER1);
}
int i;
uint32_t u32ADCvalue;
char Text[32];
int main(void)
{
	
  SYS_Init();
	init_LCD();
  clear_LCD();

	PD14 = 1;
	Init_ADC();

	ADC_START_CONV(ADC);
  while (u8ADF == 0);
  u32ADCvalue = ADC_GET_CONVERSION_DATA(ADC, 6);
	//sprintf(Text,"T = %5d", u32ADCvalue);
	//print_Line(1, Text);
	NVIC_DisableIRQ(ADC_IRQn);
	srand(u32ADCvalue);
	Init_Timer1();
	platx[0] = rand()%97;
	platx[2] = rand()%97;
	platType[0] = rand()%4;
	platType[1] = rand()%4;
	platType[2] = rand()%4;
	draw_Bmp128x8(0,0,FG_COLOR,BG_COLOR,bigsting);
	draw_Bmp32x8(platx[0],24,FG_COLOR,BG_COLOR,platSting[platType[0]]);
	draw_Bmp32x8(platx[1],40,FG_COLOR,BG_COLOR,platSting[platType[1]]);
	draw_Bmp32x8(platx[2],56,FG_COLOR,BG_COLOR,platSting[platType[2]]);
	//draw_Bmp16x8(peoplex,peopley,FG_COLOR,BG_COLOR,people);
	
  while(1)
	{
		keyin = ScanKey();
		if(keyin == 1)
		{
			
			clear_LCD();
			platx[0] = rand()%97;
			platx[1] = rand()%97;
			platx[2] = rand()%97;
			draw_Bmp32x8(platx[0],24,FG_COLOR,BG_COLOR,sting);
			draw_Bmp32x8(platx[1],40,FG_COLOR,BG_COLOR,sting);
			draw_Bmp32x8(platx[2],56,FG_COLOR,BG_COLOR,sting);
			

		}
	}
}